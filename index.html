<html>
  <head>
    <link rel='stylesheet' href='spectrum.css' />
    <link rel='stylesheet' href='style.css' />
  </head>
  <body>
    <div id="left">
      <input type="text" id="picker"></input>
      <br />
      <!--<div id="picked"></div>-->
    </div>
    <div id="results"><ul></ul></div>
    <div id="kdtree"></div>
    <script src="//code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js"></script>
    <script src="vendor/kdTree.js"></script>
    <script src="colors.json"></script>
    <script src="spectrum.js"></script>
    <script>
      var tree;
      // Pretty good color distance from
      // http://www.compuphase.com/cmetric.htm
      function colorDistance(a, b) {
        var dr = a.red - b.red;
        var dg = a.green - b.green;
        var db = a.blue - b.blue;
        var redMean = (a.red + b.red)/2;
        return (2+redMean/256)*dr*dr + 4*dg*dg + (2 + (255 - redMean)/256)*db*db;
      }

      function update(color) {
        $("#picked").css('background', color.toHex());
        var rgb = color.toRgb();
        var search = {red: rgb.r, green: rgb.g, blue: rgb.b};
        var nearest = tree.nearest(search, 10);
        nearest.sort(function(a,b){return a[1] - b[1]});

        var $list = $("#results ul");
        $list.html("");
        for(var i=0; i<nearest.length; i++) {
          var c = nearest[i][0];

          var $box = $("<div>")
            .css('background', c.hex)
            .css('display', 'inline-block')
            .css('margin-right', '10px')
            .height('30px')
            .width('30px');
          var $line = $("<li>").append($box).append(c.title);
          $list.append($line);
        }
      }

      $(function(){ // on document load

        for(var i=0; i<colors.length; i++) {
          var color = new tinycolor(colors[i].hex).toRgb();
          colors[i].red = color.r;
          colors[i].green = color.g;
          colors[i].blue = color.b;
        }
        tree = new kdTree(colors, colorDistance, ["red", "green", "blue"]);

        $("#picker").spectrum({
          flat: true,
          showInput: true,
          preferredFormat: "hex",
          move: update
        });

        // D3

        var margin = {top: 0, right: 0, bottom: 0, left: 0},
            width  = 400 - margin.left - margin.right,
            height = 400 - margin.top - margin.bottom;
        var pointRadius = 4;

        var x = d3.scale.linear()
                .range([0, width])
                .domain([-pointRadius, 255 + pointRadius]).nice();

        var y = d3.scale.linear()
                .range([height, 0])
                .domain([-pointRadius, 255 + pointRadius]).nice();

        var xAxis = d3.svg.axis()
                    .scale(x)
                    .orient("bottom");

        var yAxis = d3.svg.axis()
            .scale(y)
            .orient("left");

        var svg = d3.select("#kdtree").append("svg")
                  .attr("width", width + margin.left + margin.right)
                  .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                  .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var data = tree.pointsBFS();

        function pointToLine(d) {
          var result = {};
          switch(d.dimension) {
            case 0:
              result.x1 = d.red;
              result.y1 = 0;
              result.x2 = d.red;
              result.y2 = 255;
            break;
            case 1:
            case 2:
              result.x1 = 0;
              result.y1 = d.blue;
              result.x2 = 255;
              result.y2 = d.blue;
            break;
          }
          return result;
        }

        svg.selectAll(".point")
          .data(data)
        .enter()
        .append("circle")
          .attr("class", "point")
          .attr("r", pointRadius)
          .attr("cx",    function(d) { return x(d.red);  })
          .attr("cy",    function(d) { return y(d.blue); })
          .style("fill", function(d) { return d.hex;     })

        svg.selectAll(".point-line")
          .data(data)
        .enter()
        .append("line")
          .attr("class", "point-line")
          .attr("x1",    function(d) { return x(pointToLine(d).x1); })
          .attr("y1",    function(d) { return y(pointToLine(d).y1); })
          .attr("x2",    function(d) { return x(pointToLine(d).x2); })
          .attr("y2",    function(d) { return y(pointToLine(d).y2); })
          .attr("stroke",function(d) {
            switch(d.dimension) {
              case 0: return "red";
              case 1: return "blue";
              case 2: return "green";
            }
          })
          .attr("stroke-width", 1)
          .attr("opacity", 0.3);

      });
    </script>
  </body>
</html>
